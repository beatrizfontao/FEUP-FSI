# FSI - Malware

---

# Botnets

Rede de computadores com um sistema de comando e controlo(C2) que é capaz de controlar computadores normais. O controlador envia comandos através da rede (spam, phishing,...).

As botnets são muito avançadas, sistemas que se podem atualizar automaticamente.

Dois tipos:
- Centralizada: vários servidores para robustez (mais comum)
- Peer-to-peer: auto organizada, pode ter uma estrutura hierárquica

Duas formas de comunicar: 
- push: servidor envia os comandos
- pull: periodicamente o bot pergunta se há comandos

Muitos destes sistemas evoluiram para terem a capacidade de recuperar e serem resilientes no caso do servidor ser alvo de ataque.

### Deteção e Combate

Como detetar e desativar uma botnet.

Estratégias:
- detetar malware na máquina comprometida
- na rede, tentar detetar tráfego com C2
- criar honeypots para serem comprometidas e monitorizadas

Combate:
- Isolar as máquinas alvo
- Isolar/desligar o C2
- Tomar controlo do sistema C2 e desativar a botnet

---

# Erros de Deteção

Falso positivo: alerta para um problema que não existe<br>
Falso negativo: ausência de alerta para problema existente

A precisão refere-se à probabilidade de ocorrer estes erros.

- I => evento de intrusão, D => evento de alerta/deteção
- Falso positivo => Pr [ D | not I]
- Falso negativo => Pr [ not D | I]

Não existe nenhum sistema que não cometa destes erros. É necessário procurar o equilíbrio.

## Como se deteta malware?

- **Signature-based**: reconhecer assinaturas e padrões de ataques(através de back listing). Fácil de implementar, eficaz contra ataques conhecidos.
- **Anomalias**: sistema que possui um modelo do seu funcionamento normal e que quando verifica algum desvio da atividade padrão, dá um alerta. Menos preciso e sensível a cenários mais raros.
- **Integridade/especificação**: especificar o que é correto(através de white listing). Pode apanhar ataques novos, mas exige mais esforço porque tem de estar constantemente atualizado.

# Antivirus

## Deteção de Assinaturas

Virus instalam-se na máquina e deixam vestígios. Procurar padrões do virus quando este é reconhecido.

Dificuldades:
- onde e como procurar esses padrões
- como detetar virus que mudam de forma

Onde procurar: normalmente string padrão no começo ou no final de um ficheiro.

Virus podem utilizar criptografia para disfarçar código malicioso.

## Antivirus modernos

Bloqueio de URL/Web: utilizadores são avisados/impedidos de visitar sites perigosos.

Scanning de rede(HTTP) para detetar e bloquear ataques conhecidos e comunicação de malware.

Analisar documentos que são descarregados.

## HIDS - Host Based Intrusion Detection System

"Olhar" para dentro da máquina. Executar dentro de uma sandbox programas que ainda não são de confiança e analisar a utilização de recursos e comportamentos suspeitos.

Scaning de ficheiros para deteção de malware no disco.
Scanning de memória, caso o malware não se "guarde" no disco.

## Deteção na rede (NIDS)

Network Oriented Intrusion Detection System - Monitorizar a rede.

Analisar protocolos, assinaturas e comportamentos.

Execução "shadow" para deteção de problemas: e.g., análise de PDF, Flash, etc. - extrair diretamente dos pacotes.

Logging => análise forense: analisar os resultados para tentar reconstruir os ataques.

Sistema de atualizações de assinaturas baseado em black lists.

## NIDS vs HIDS

Complementares.

NIDS:
- um sistema único protege diversos sistemas
- mais simples de gerir e instalar - autónoma
- não ocupa recursos nos sitemas que protege
- mais dificil acesso para os atacante

HIDS:
- permite mais precisão
- protege de ameaças que não vêm da rede(USB)
- é possível observar dados que vem cifrados da rede
- não afeta o sistema todo, é possível ajustar as configurações de segurança com base nas necessidades de cada host

# Proxies de aplicação

Obriga o tráfego de uma ou mais aplicações a passar por proxy, funciona como um Man-in-the-Middle.

## Network IDS/IPS

Existe mecanismo de monitorização tráfego que procuram especificamente malware.

Se for ao nível da rede:<br>
Vantagens:
 - Não é necessário estar a configurar máquinas individuais

Desvantagens:
- Exigentes em termos de processamento
- Menos preciso (para reduzir falsos negativos => muitos falsos positivos)
- Não lida com código cifradonem com outras formas de evasão

## Host-Based IDS/IPS

Nas máquinas mais críticas fazer uma deteção mais agressiva. Por exemplo, remoção da camada criptográfica ou identificação de padrões de ataques.

Não se deve generalizar por causo do custo de adotar esta aproximação em todas as máquinas.

## Análise de Logs

- Ferramentes fáceis de obter
- Corridas off-line
- Analisam os resultados do processamento das mensagens e o comportamento das máquinas
- Apenas reativo => após deteção do ataque : não permite prevenir/bloquear o ataque
- Logs podem ser alterados pelos atacantes
- Podem permitir melhorar a configuração do sistema

## Pen-Testing

Em vez de "esperar" um ataque, simulam-se situações de ataque para testar o sistema.

Vantagens:
- Proativo: uma falha não significa perda de valor e permite corrigir o sistema
- Permite optimizar os sistemas

Desvantagens:
- Custos podem ser elevados(contratação de profissionais)
- Mesmo um ataque simulado pode causar danos ao sistema

## Honey-Pots

Colocar nos sistemas máquinas desprotegidas que chamem à atenção dos atacantes. Estas máquinas são observadas de perto para verificar possíveis ataques.
